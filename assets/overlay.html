<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Kick Overlay</title>
    <style>
        body { margin: 0; overflow: hidden; background: transparent; }
        #media-container {
            position: absolute; top: 0; left: 0; width: 100vw; height: 100vh;
            pointer-events: none;
            display: block; 
        }
        video, img, audio { 
            max-width: 100%; 
            max-height: 100%; 
            will-change: transform, opacity;
            position: absolute;
            transition: opacity 0.2s ease-out; /* Suaviza la desaparici贸n */
        }
    </style>
</head>
<body>
    <div id="media-container"></div>

    <script>
        const container = document.getElementById('media-container');
        let socket = null;
        let retryInterval = 2000; 

        function connect() {
            socket = new WebSocket("ws://127.0.0.1:8081/ws");
            socket.onopen = () => console.log(" Conectado al Overlay");
            socket.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    if (data.action === "play_media") playMedia(data);
                } catch (e) { console.error(e); }
            };
            socket.onclose = () => setTimeout(connect, retryInterval);
            socket.onerror = () => socket.close();
        }

        function playMedia(data) {
            let element;
            // Aseguramos que volumen y duraci贸n sean n煤meros
            const vol = (data.volume !== undefined) ? data.volume / 100 : 1.0;
            const duration = data.duration ? parseFloat(data.duration) : 0;

            // --- Funci贸n Helper para eliminar el elemento ---
            const removeElement = () => {
                if (!element) return;
                element.style.opacity = '0'; // Desvanecer primero
                setTimeout(() => {
                    if (element && element.parentNode) {
                        element.parentNode.removeChild(element);
                    }
                    element = null; // Liberar memoria
                }, 200); // Esperar la transici贸n CSS
            };

            if (data.type === 'video') {
                element = document.createElement('video');
                element.src = data.url;
                element.autoplay = true;
                element.volume = vol; 
                element.style.opacity = "0"; // Iniciar invisible

                // 1. SIEMPRE escuchar el final natural del video
                element.addEventListener('ended', removeElement);

                // 2. ADICIONALMENTE, si hay duraci贸n forzada, configurar timeout
                if (duration > 0) {
                    setTimeout(removeElement, duration * 1000);
                }

                element.onloadedmetadata = () => {
                    const scale = data.scale || 1.0;
                    const contW = container.clientWidth;
                    const contH = container.clientHeight;
                    const vidW = element.videoWidth * scale;
                    const vidH = element.videoHeight * scale;

                    if (data.random) {
                        element.style.transformOrigin = 'top left'; 
                        element.style.transform = `scale(${scale})`;
                        const maxLeft = Math.max(0, contW - vidW);
                        const maxTop = Math.max(0, contH - vidH);
                        element.style.left = Math.floor(Math.random() * maxLeft) + 'px';
                        element.style.top = Math.floor(Math.random() * maxTop) + 'px';
                    } else {
                        element.style.transformOrigin = 'center center';
                        element.style.left = '50%';
                        element.style.top = '50%';
                        element.style.transform = `translate(-50%, -50%) scale(${scale})`;
                    }
                    
                    element.style.opacity = "1"; // Mostrar
                    element.play().catch(e => console.log("Error play:", e));
                };

            } else if (data.type === 'audio') {
                element = document.createElement('audio');
                element.src = data.url;
                element.autoplay = true;
                element.volume = vol;
                
                element.addEventListener('ended', removeElement);
                
                if (duration > 0) {
                    setTimeout(removeElement, duration * 1000);
                }
            }

            if (element) container.appendChild(element);
        }

        connect();
    </script>
</body>
</html>